<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WORKQUEUE Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:1100px;margin:28px auto;padding:0 16px;line-height:1.5;color:#111}
    .top a{color:#0b57d0;text-decoration:none}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:14px 0}
    .card{border:1px solid #ddd;border-radius:10px;padding:10px 12px}
    .num{font-size:24px;font-weight:700}
    .muted{color:#666;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .PENDING{background:#fff7ed;color:#9a3412}
    .DOING{background:#eff6ff;color:#1d4ed8}
    .DONE{background:#ecfdf5;color:#047857}
    .BLOCKED{background:#fef2f2;color:#b91c1c}
    .card a{color:inherit;text-decoration:none;display:block}
    .card a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="top"><a href="/">← 홈</a> · <a href="/projects/internal/">internal</a> · <a href="/md-viewer.html?file=/projects/internal/WORKQUEUE.md">원문 보기</a></div>
  <h1>WORKQUEUE Dashboard</h1>
  <p class="muted">소스: <a href="/md-viewer.html?file=/WORKQUEUE.md"><code>/WORKQUEUE.md</code></a> (우선) · <a href="/md-viewer.html?file=/projects/internal/WORKQUEUE.md"><code>/projects/internal/WORKQUEUE.md</code></a> (fallback) · <span id="updatedAt">업데이트 확인 중...</span></p>

  <div class="cards" id="summary"></div>

  <h2>실행 보드 (1인 기업 모드)</h2>
  <table>
    <thead><tr><th>구분</th><th>항목</th></tr></thead>
    <tbody id="boardRows"></tbody>
  </table>

  <h2>Queue 상태</h2>
  <table>
    <thead><tr><th>ID</th><th>작업</th><th>Status</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>

<script>
async function run(){
  let md = '';
  let sourcePath = '/WORKQUEUE.md';
  try {
    const primary = await fetch('/WORKQUEUE.md', { cache: 'no-store' });
    if (!primary.ok) throw new Error('primary-not-ok');
    md = await primary.text();
  } catch (e) {
    const fallback = await fetch('/projects/internal/WORKQUEUE.md', { cache: 'no-store' });
    md = await fallback.text();
    sourcePath = '/projects/internal/WORKQUEUE.md';
  }

  const board = { NOW: [], NEXT: [], LATER: [] };
  let current = null;
  md.split('\n').forEach(line => {
    if (line.startsWith('### NOW')) current = 'NOW';
    else if (line.startsWith('### NEXT')) current = 'NEXT';
    else if (line.startsWith('### LATER')) current = 'LATER';
    else if (current && line.trim().startsWith('- ')) board[current].push(line.replace(/^-\s*/, '').trim());
    else if (line.startsWith('## Queue')) current = null;
  });

  const taskRegex = /^### \[(.+?)\] (.+)$/gm;
  const tasks = [];
  let m;
  while ((m = taskRegex.exec(md)) !== null) {
    const start = m.index;
    const next = md.indexOf('\n### [', start + 1);
    const block = md.slice(start, next === -1 ? md.length : next);
    const statusMatch = block.match(/- Status: (PENDING|DOING|DONE|BLOCKED)/);
    const outMatch = block.match(/\]\((\/md-viewer\.html\?file=[^)]+|\/[^)\s]+)\)/);
    const primaryUrl = outMatch ? outMatch[1] : `/md-viewer.html?file=/projects/internal/WORKQUEUE.md`;
    tasks.push({ id: m[1], title: m[2], status: statusMatch ? statusMatch[1] : 'PENDING', primaryUrl });
  }

  const counts = {PENDING:0, DOING:0, DONE:0, BLOCKED:0};
  tasks.forEach(t => counts[t.status] = (counts[t.status]||0)+1);

  document.getElementById('updatedAt').textContent = `최근 갱신: ${new Date().toLocaleString('ko-KR')} · 로드소스: ${sourcePath}`;

  const summary = document.getElementById('summary');
  summary.innerHTML = `
    <div class="card"><a href="#status=ALL"><div class="num">${tasks.length}</div><div>전체 작업</div></a></div>
    <div class="card"><a href="#status=PENDING"><div class="num">${counts.PENDING}</div><div>PENDING</div></a></div>
    <div class="card"><a href="#status=DOING"><div class="num">${counts.DOING}</div><div>DOING</div></a></div>
    <div class="card"><a href="#status=DONE"><div class="num">${counts.DONE}</div><div>DONE</div></a></div>
    <div class="card"><a href="#status=BLOCKED"><div class="num">${counts.BLOCKED}</div><div>BLOCKED</div></a></div>
  `;

  const boardRows = document.getElementById('boardRows');
  boardRows.innerHTML = ['NOW','NEXT','LATER'].map(k => `
    <tr>
      <td><strong>${k}</strong></td>
      <td>${(board[k].length ? board[k] : ['-']).join('<br/>')}</td>
    </tr>
  `).join('');

  const statusFilter = (location.hash.match(/status=(ALL|PENDING|DOING|DONE|BLOCKED)/) || [,'ALL'])[1];
  const filtered = statusFilter === 'ALL' ? tasks : tasks.filter(t => t.status === statusFilter);

  const rows = document.getElementById('rows');
  rows.innerHTML = filtered.map(t => `
    <tr>
      <td><code>${t.id}</code></td>
      <td><a href="${t.primaryUrl}">${t.title}</a></td>
      <td><a href="${t.primaryUrl}"><span class="badge ${t.status}">${t.status}</span></a></td>
    </tr>
  `).join('');
}
run();
window.addEventListener('hashchange', run);
setInterval(run, 60000);
</script>
</body>
</html>
